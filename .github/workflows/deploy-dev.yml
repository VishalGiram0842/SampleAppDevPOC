name: Deploy to DEV and CITSS
on:
  push:
    branches:
      - dev
      - CITSS

permissions:
  contents: read
  actions: write

jobs:
  determine-env:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      event_type: ${{ steps.set-env.outputs.event_type }}
    steps:
      - name: Determine environment from branch
        id: set-env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            echo "environment=DEV" >> $GITHUB_OUTPUT
            echo "event_type=run-dev-tests" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/CITSS" ]; then
            echo "environment=CITSS" >> $GITHUB_OUTPUT
            echo "event_type=run-citss-tests" >> $GITHUB_OUTPUT
          fi

  deploy-dev:
    needs: determine-env
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Fake deploy to ${{ needs.determine-env.outputs.environment }}
        run: echo "Simulating ${{ needs.determine-env.outputs.environment }} deployment for POC..."
      
      - name: Trigger QA automation via API
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTOMATION_REPO_TOKEN }}
          script: |
            github.rest.repos.createDispatchEvent({
              owner: 'VishalGiram0842',
              repo: 'SampleRepoForCICD',
              event_type: '${{ needs.determine-env.outputs.event_type }}',
              client_payload: {
                source_repo: context.repo.repo,
                environment: '${{ needs.determine-env.outputs.environment }}'
              }
            })
      
      - name: Post Deployment
        run: echo "Deployment to ${{ needs.determine-env.outputs.environment }} completed"
